# frozen_string_literal: true

require_relative '../../spec_helper'
require 'wpxf/modules'

describe Wpxf do
  describe '.build_module_list' do
    it 'builds an array of hashes containing the modules for the specified namespace' do
      result = Wpxf.build_module_list(Wpxf::Exploit, 'modules')
      expect(result[0]).to include(:class, :name)

      mod = result.find { |m| m[:name] == 'exploit/shell/admin_shell_upload' }
      expect(mod).to_not be_nil
      expect(mod[:class]).to be Wpxf::Exploit::AdminShellUpload
    end
  end
end

describe 'Wpxf::Auxiliary' do
  describe '.module_list' do
    it 'builds an array of hashes containing the auxiliary modules' do
      list = Wpxf::Auxiliary.module_list
      expect(list).to_not be_nil
      expect(list[0]).to include(:class, :name)
    end
  end

  it 'should contain no duplicate classes' do
    classes = []
    Dir.glob('modules/auxiliary/**/*.rb').each do |f|
      code = File.read(f)
      classes.push(code[/class\s+(.+)?\s/, 1])
    end

    duplicates = classes.detect { |e| classes.count(e) > 1 }
    expect(duplicates).to be_nil
  end
end

describe 'Wpxf::Exploit' do
  it 'should contain no duplicate classes' do
    classes = []
    Dir.glob('modules/exploit/**/*.rb').each do |f|
      code = File.read(f)
      classes.push(code[/class\s+(.+?)\s/, 1])
    end

    duplicates = classes.detect { |e| classes.count(e) > 1 }
    expect(duplicates).to be_nil
  end

  describe '.module_list' do
    it 'builds an array of hashes containing the exploit modules' do
      list = Wpxf::Exploit.module_list
      expect(list).to_not be_nil
      expect(list[0]).to include(:class, :name)
    end
  end
end

describe 'Wpxf::Payloads' do
  describe '.payload_list' do
    it 'builds an array of hashes containing the module payloads' do
      list = Wpxf::Payloads.payload_list
      expect(list).to_not be_nil
      expect(list[0]).to include(:class, :name)
    end
  end
end
